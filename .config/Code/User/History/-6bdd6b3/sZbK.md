# Water Meta-Analysis

Code for [Water Treatment and Child Mortality: A Meta-analysis and Cost-effectiveness Analysis](https://bfi.uchicago.edu/working-paper/2022-26/) by Kremer, Luby, Maertens, 
Tan, and WiÄ™cek.

## Table of Contents

- [Replication Issues](#replication-issues)
- [Replication Instructions](#replication-instructions)
- [Code Checks](#code-checks)
- [Directory Structure](#directory-structure)
- [Figures And Tables](#figures-and-tables)
- [Mapping Old Files](#mapping-old-figure-names-to-new-figure-names)

## Replication Issues

- `analysis_output/tables/table-cea-estimates.csv` committed on GitHub doesn't match the 
working paper. Differences are qualitatively immaterial but do occur (e.g. cost 
per death averted of 3063 not 3067).


## Replication Instructions


Run order:

- `bayes.R` *
- `bayes_priors_v2.R` *
- `prepare_models.R` *
- `cea.R`
- `generate_outputs.R`


Starred steps (\*) will be called by `cea.R` and `generate_outputs.R` and 
so don't need to be run manually. Some parts of (\*) can be skipped as they take a long time and fitted 
Bayesian models can be loaded from .RDS files instead.





## Code Checks


### `data_prep.R`

Inputs: `data/summary_data.csv`

Outputs:

Runs: Yes

Notes: sourced by `bayes_priors_v2.R`

### `bayes.R`

Inputs: 
- `data_prep.R`
- `helpers.R`

Outputs: 
- `analysis_output/stan/bg_{loo,none,loo_full,subsets}.rds`

Runs: Yes, slowly

Notes:

### `bayes_priors_v2.R`

Inputs: 
- `data_prep.R` 
- `helpers.R`

Outputs: 
- `analysis_output/stan/bg_alt_priors_8mar2022.rds`

Notes: `bayes.R` should be run before this file.

### `cea.R`


Inputs: 
- `prepare_models.R`
- `simulations/check-multiplication-model.R`
- `analysis_output/stan/bg_alt_priors_8mar2022.rds`

Outputs: 
- `analysis_output/tables/table-cea-estimates.csv`

Notes:

### `generate_outputs.R`

Inputs: 
- `prepare_models.R`

Outputs: `analysis_output/figures/`
- `peto-bubble-level.png` 
- `peto-bubble-year.png`
- `peto-bubble-diarr.png`
- `ma-week-plot.png`
- `peto-bubble-compliance.png`
- `bayes-forest.png`
- `forest-rd.png`
- `peto-forest.png`
- `fig-compliance-diarr-hist.png`
- `fig-study-breakdown.png`
- `forest-no-corrections.png`
- `peto-bubble-diarr-eff.png`
- `peto-funnel.png`

- `analysis_output/tables/het-te-metareg-table.csv`

Notes:


### `inclusion_exclusion_analysis.R`

Inputs: 
- `data/Wolf et al studies.xlsx`

Outputs:

Runs: Yes

Notes:

### `prepare_models.R`

Inputs: 
- `data_prep.R`
- `helpers.R`

Outputs:

Runs: Yes

Notes:


### `diarrhea-pub-bias.R`

Inputs:
- `data/Wolf et al studies.xlsx`

Outputs: 
- `publication_bias/Applications/water/{all,chlorine}-diarrhea-{estimates,labels}.csv`
- `analysis-output/figures/diarr-pub-bias-funnel.png`
- `analysis-output/tables/diarr-pub-bias-eggers.csv`



## Directory Structure


### `analysis_output/`

Contains output from analysis files.
- Has subfolders `figures/`, `stan/`, and `tables`.

### `data/`
- `individual_data.csv` is generated by mortality_time_trends.R (in the mortality_counts folder). The variables are as follows: 
  - death: an indicator for whether the child died during the study period (1 = died, 0 = did not die)
  - wtreatment: an indicator for whether the child was in the treatment group (1 = treatment, 0 = control)
  - age_month: the child's age at baseline in months
  - age_year: the child's age at baseline in years
  - age_measure_original: the units in which age was originally recorded
  - study: the study from which the observation comes from
  - treatment_time: the time of treatment
  - event_time_lb: lower bound on the time of death (if death = 1)
  - event_time_ub: upper bound on the time of death (if death = 1)
  - follow_up_time: the time of follow-up 
  - precision_trt: the precision of the date recorded in treatment_time (e.g., nearest week, nearest month, nearest year, etc.)
  - precision_evt: the precision of the dates recorded in event_time_lb and event_time_ub
  - precision_fut: the precision of the date recorded in follow_up_time
  - crossed_five: an indicator for whether the child crossed the age of five during the study period
- `individual_mortality_data.Rda` is generated by XYZ, it has N rows and 
N columns. It is an old data file which is no longer in use.
- `summary_data.csv` is generated by XYZ. It has N rows and ...
- `Wolf et al studies.xlsx` contains data provided in the supplementary material Wolf et al., 2018. The original datset from extracted from the publication avaialble [here](https://onlinelibrary.wiley.com/doi/10.1111/tmi.13051). The data was provided for 80 studies included in the meta-anlysis. We added the relevant data for studies included in the meta-anlysis but not included in the Wolf et al., 2018 study (Peletz et al., 2012, 	
Null et al., 2018, 	Luby et al., 2018, Humphrey et al., 2019, Kirby et al., 2019, Haushofer et al., 2020, Dupas et al., 2021, and ucation vs control)
Quick et al., 1999). In addition to the existing data, we added the following information for each of the studies - 1. Compliance rate, and 2. How is compliance defined. Wolf et al., 2018 collects estimates for under-5 diarrhea morbidity in studies with any WaSH intervention.


### `mortality_counts/`

Mortality data from each study can be found here in its own sub-directory.

`mortality_time_trends.R` generates the data file individual_data.csv (in the data folder).
`age_summary.Rmd` produces a summary of the age variables across all studies.


### `publication_bias/`

Andrews and Kasy publication bias code.

### `simulations/`


## Figures and Tables

- `table-cea-estimates.csv` is generated by `cea.R` and describes cost per DALY estimates
- `age-distribution.csv` is generated by `mortality_time_trends.R` 

__`generate_output.R`__:

- `het-te-metareg-table.csv` shows heterogeneous effects across characteristics.
- `diarr-pub-bias-eggers.csv` calculates Eggers test for publication bias using all studies in Wolf et al 
and just studies that mention chlorination in Wolf et al.
- `diarr-pub-bias-funnel.png` funnel plot for publication bias in diarrhea using all Wolf and chlorination Wolf 
studies.
- `many-summ-peto-bayes.csv` calculates Peto and Bayesian OR across many specifications.
- `peto-bayes-summary-mortality.csv` shows estimates for mortality ORs using the 12 vs 15 studies.
- `study-subset-estimates.csv` contains estimates for 4(or 5?) studies.
- `table-diff-means.csv` calculates differences in means across compliance, setting, water source type.
- `table-elpd.csv` expected log predictive density for different models.
- `table-loo-study.csv` sensitivity results from dropping one study at a time.
- `table-peto-bayes-row-10.csv` TODO this takes the 10th row of a table with Peto and Bayes estimates and Ed 
doesn't know what for.
- `peto-funnel.png` is a funnel plot to assess publication bias in diarrhea MORTALITY, 
not morbidity.

- `mortality-*` plots are generated by `mortality_time_trends.R`
- All other plots are generated by `generate_outputs.R`


### Mapping old figure names to new figure names


Notes: All `peto-bubble-*.png` estimates now use odds ratio and not log odds ratio 
(TODO ed note: I don't think I did this, but maybe it was intentional by someone else?).

- `Fig3_funnel.png` -> missing
- `FigS12_filtration.png` -> missing (this would probably be served better with a 
different plot format)
- `FigS12_chlorination.png`  -> missing (also as above)
- `FigS12_spring.png`  -> missing (also as above)
- `FigS10.png` -> `peto-bubble-level.png` (not missing! but same type as above)
- `FigS12.png` -> `peto-bubble-year.png`
- `FigS8.png` -> `peto-bubble-diarr.png`
- `mortality_counts2.png` -> `mortality-counts-month-treat-control.png`
- `FigS4.png` -> `ma-week-plot.png`
- `mortality_counts3.png` -> `mortality-counts-years.png`
- `FigS9.png` -> `peto-bubble-compliance.png`
- `Fig2_bayes_13.png` -> `bayes-forest.png`
- `mortality_counts1.png` -> `mortality-counts-month.png`
- `FigS1_RD.png` -> `forest-rd.png`
- `Fig2_peto_13.png` -> `peto-forest.png`
- `FigS5.png` -> `fig-compliance-diarr-hist.png`
- `FigS6.png` -> `fig-study-breakdown.png`
- `FigS1.png` -> `forest-no-corrections.png`
- `FigS11.png` -> `peto-bubble-diarr-eff.png`

### Mapping old table names to new table names

- `age_distribution_all.csv` -> `age-distribution-all.csv`
- `table2_v2.csv` -> `table-cea-estimates.csv`
- `tableS11.csv` -> `table-diff-means.csv`
- `tableS10.csv` -> `table-peto-bayes-row-10.csv` (ed: didn't have a better name)
- `tableS9.csv` -> `table-elpd.csv`
- `tableS6.csv` -> `many-summ-peto-bayes.csv`
- `tableS5.csv` -> `table-loo-study.csv`
- `tableS4.csv` -> `study-subset-estimates.csv`
- `tableS3.csv` -> `peto-bayes-summary-mortality.csv`
- `table2.csv` -> disappeared into the ether, presumably superceded by `table2_v2.csv`
