\documentclass{article}
\usepackage{listings}
\usepackage{takeup_beamer_header}
\begin{document}
    
\textit{I think the multilevel additions to the truncated normal distance model 
might be slightly off, 
the lognormal is fine I believe.}
\section*{Truncated Normal Distance Likelihood}

With county and cluster effects, $\alpha_l, \delta_c$:
\begin{align*}
  D_{lc} &= \alpha_l + \delta_c + \pi_{glc} + U_D, \ U_D \sim N(0, \eta_g) \\
  Pr(D < d \ |\  D > 0 ) &= Pr(\alpha_c + \delta_c + \pi_{glc} + U_D < d \ | \ 
  \alpha_c + \delta_c + \pi_{glc} + U_D > 0) \\
   &= Pr( U_D < d -  \underbrace{(\alpha_c + \delta_c + \pi_{glc})}_{\mu_D}\   |\  
    U_D > - \underbrace{(\alpha_c + \delta_c + \pi_{glc})}_{\mu_D}) \\ 
   &= Pr\left( \frac{U_D}{\eta_g} <  \frac{d - \mu_D}{\eta_g} \   |\  
    \frac{U_D}{\eta_g} > - \frac{\mu_D}{\eta_g}\right) \\  
    &= Pr(Z < \frac{d - \mu_D}{\eta_g} \ |\  Z > -\frac{\mu_D}{\eta_g} ) \\
    &= \frac{
      \Phi\left( \frac{d - \mu_D}{\eta_g}\right) - \Phi\left(
        -\frac{\mu_D}{\eta_g}
      \right)
    }{1 - \Phi\left(-\frac{\mu_D}{\eta_g}\right)}
\end{align*}

Taking derivatives to get the pdf:

\begin{align*}
  \phi^*(d; \theta) &= \frac{
    \frac{1}{\eta_g}\phi\left(\frac{d - \mu_D}{\eta_g}\right)
  }{1 - \Phi\left(-\frac{\mu_D}{\eta_g}\right)} \\ 
   &= \frac{
    \frac{1}{\eta_g}\phi\left(\frac{d - \mu_D}{\eta_g}\right)
  }{\Phi\left(\frac{\mu_D}{\eta_g}\right)} \\ 
\end{align*}


Taking logs:

\begin{align*}
  \log \phi^*(d;\theta) &= \log \phi\left(\frac{d - \mu_D}{\eta_g}\right) - 
  \log(\eta_g) - \log \Phi\left(\frac{\mu_D}{\eta_g}\right)
\end{align*}

As far as I can tell, in Stan we estimate something slightly different:

\begin{itemize}
  \item We don't have $\log(\eta_g)$ (does it cancel somewhere I'm missing?)
  \item $\mu_D = \alpha_l + \delta_c + \pi_{glc}$ but in Stan, the $\Phi(\cdot)$ 
   term doesn't contain the multilevel parameters $\alpha_l, \delta_c$.
   \item We also have a `+ +' across lines which I think should crash the sampler?
\end{itemize}

\subsubsection*{Stan code}
\begin{lstlisting}
  if (fit_dist_model_to_data) {
    vector[num_dist_group_mix] group_dist_mix_lp;
    
    for (group_dist_mix_index in 1:num_dist_group_mix) {
      if (lognormal_dist_model) {
        group_dist_mix_lp[group_dist_mix_index] =
          lognormal_lpdf(cluster_standard_dist[cluster_index] | group_dist_mean[curr_assigned_dist_group, group_dist_mix_index] 
                                                                + county_dist_effect[curr_assigned_dist_group, cluster_county_id[cluster_index]] 
                                                                + cluster_dist_effect[curr_assigned_dist_group, cluster_index],
                                                                group_dist_sd[curr_assigned_dist_group, group_dist_mix_index])
          + log(group_dist_mix[curr_assigned_dist_group, group_dist_mix_index]); 
      } else {
        group_dist_mix_lp[group_dist_mix_index] = 
          normal_lpdf(cluster_standard_dist[cluster_index] | group_dist_mean[curr_assigned_dist_group, group_dist_mix_index] 
                                                             + county_dist_effect[curr_assigned_dist_group, cluster_county_id[cluster_index]] 
                                                             + cluster_dist_effect[curr_assigned_dist_group, cluster_index],
                                                             group_dist_sd[curr_assigned_dist_group, group_dist_mix_index])  
          + normal_lccdf(0 | group_dist_mean[curr_assigned_dist_group, group_dist_mix_index], group_dist_sd[curr_assigned_dist_group, group_dist_mix_index]) +
          + log(group_dist_mix[curr_assigned_dist_group, group_dist_mix_index]); 
      }
    }
    
    target += log_sum_exp(group_dist_mix_lp);
  }
\end{lstlisting}

\section*{Presentation Slides Reference}
 Casual model function 
 \begin{equation*}  
   d \leftarrow f_D(g; m, \boldsymbol{\pi}, u_D) = \pi_{gm} + u_D 
 \end{equation*} 


 Finite-mixture statistical model ($M = 2$) 
 \begin{align*} 
 \prob{D(g) = d} = \prob{D = g | G = g} = \sum_m^M \lambda_m \frac{\phi\left(\frac{d - \pi_{gm}}{\eta_{gm}}\right)}{1 - \Phi\left(\frac{d - \pi_{gm}}{\eta_{gm}}\right)}  
 \end{align*} 
 and 
 \begin{align*} 
   \boldsymbol{\rho} &\sim \mathtt{Dirichlet}(\boldsymbol{\iota}_M) \\ 
   \pi_{gm} &\sim \mathtt{Normal^+}(0, 1) \\ 
   \eta_{gm} &\sim \mathtt{Normal^+}(0, 1). 
 \end{align*} 
\end{document}

