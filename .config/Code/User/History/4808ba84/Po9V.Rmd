---
title: "Social Signaling and Prosocial Behavior"
subtitle: "Experimental Evidence in Community Deworming in Kenya"
author: "Anne Karing (Princeton) and Karim Naguib"
date: "3/30/2021"
output: 
  beamer_presentation:
    keep_tex: yes
    includes:
      in_header: takeup_beamer_header.sty
bibliography: /home/karim/Documents/library.bib
---

```{r takeup-present-setup, include=FALSE}
library(magrittr)
library(tidyverse)
library(broom)
library(ggrepel)
library(ggmap)
library(ggstance)
library(gridExtra)
library(cowplot)
library(rgeos)
library(sp)
library(rgdal)
library(knitr)
library(modelr)
library(car)
library(rstan)
library(latex2exp)
library(ggthemes)

library(econometr)

source(file.path("..", "rct-design-fieldwork", "takeup_rct_assign_clusters.R"))
source(file.path("..", "analysis_util.R"))
source(file.path("..", "dist_structural_util.R"))

knitr::read_chunk(file.path("..", "analysis_util.R"), labels = "analysis-util")

options(dplyr.show_progress = FALSE, digits = 4, knitr.kable.NA = '')

knitr::opts_chunk$set(echo = FALSE, cache = TRUE, cache.path = "takeup_structural_beamer-cache/", fig.path = "takeup_structural_beamer-fig/", fig.align = "center")

canva_palette_vibrant <- "Primary colors with a vibrant twist"
```

```{r ggplot-theme, cache=FALSE}
theme_set(theme_minimal() +
            theme(legend.position = "bottom"))
```

```{r proj4}
wgs.84 <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"
kenya.proj4 <- "+proj=utm +zone=36 +south +ellps=clrk80 +units=m +no_defs"
```

```{r load-experiment-design-data}
rct.schools.data <- read_rds(file.path("..", "data", "takeup_rct_schools.rds"))
rct.cluster.selection <- read_rds(file.path("..", "data", "rct_cluster_selection_2.0.rds"))
cluster.strat.data <- read_rds(file.path("..", "data", "takeup_processed_cluster_strat.rds"))

load(file.path("..", "data", "takeup_village_pot_dist.RData"))
```

```{r load-analysis-data}
load(file.path("..", "data", "analysis.RData"))

standardize <- as_mapper(~ (.) / sd(.))
unstandardize <- function(standardized, original) standardized * sd(original)

nosms_data <- analysis.data %>% 
  filter(sms.treatment.2 == "sms.control") %>% 
  left_join(village.centers %>% select(cluster.id, cluster.dist.to.pot = dist.to.pot),
            by = "cluster.id") %>% 
  mutate(standard_cluster.dist.to.pot = standardize(cluster.dist.to.pot)) %>% 
  group_by(cluster.id) %>% 
  mutate(cluster_id = cur_group_id()) %>% 
  ungroup()

monitored_nosms_data <- analysis.data %>% 
  filter(mon_status == "monitored", sms.treatment.2 == "sms.control") %>% 
  left_join(village.centers %>% select(cluster.id, cluster.dist.to.pot = dist.to.pot),
            by = "cluster.id") %>% 
  mutate(standard_cluster.dist.to.pot = standardize(cluster.dist.to.pot)) %>% 
  group_by(cluster.id) %>% 
  mutate(cluster_id = cur_group_id()) %>% 
  ungroup()

analysis_data <- monitored_nosms_data
```

```{r version}
fit_version <- 51 

```

```{r load-processed-dist-fit, dependson="version"}
load(file.path("..", "temp-data", str_interp("processed_dist_fit${fit_version}_lite.RData")))

dist_fit_data %<>%
  left_join(tribble(
    ~ fit_type,        ~ model_color,
      "fit",           "black", 
      "prior-predict", "darkgrey",
  ), by = "fit_type")
```

```{r common-functions}
delta <- function(v, ...) dnorm(v, ...) / ((pnorm(v, ...) * pnorm(v, ..., lower.tail = FALSE)))
```

# Introduction

## Motivation

* According to WHO approx. 2 billion people are infected with soil-transmitted helminths (STH) worldwide.
* Development burden for children and adults in many developing countries. Mild infections often are asymptomatic. More severe infections lead to abdominal pain, iron-deficiency, anemia, malnutrition, and stunting.  

## Motivation 

* Deworming is a public good: 
    - Low private returns for many individuals. 
    - Children are dewormed in schools but remaining reservoir among adult population fosters reinfection. 
    - Most of social benefits come through reduced disease transmission. 
* Cost of screening is 4 to 10 times that of deworming treatment. Deworming drugs are safe, no side effects for uninfected. 

## Motivation

**How can we get adults to take up deworming treatment within a short time and cheap way? **

We can think of other behaviors that have similar public good characteristics, where we observe insufficient take-up and where formal enforcement mechanisms are very costly.

## Contribution

Manipulate the visibility of individuals' actions by introducing social signals in the context of a novel community deworming program: 

* Can we increase adults' willingness to take-up deworming treatment by making (in)actions visible?
* Does visibility in actions affect deworming decisions through social image concerns, or social influence through others? 
* Changing the cost of deworming, how do different marginal types respond (differently) to signals/material incentives, how do changes in average take-up affect deworming decisions/the returns to signaling?
<!-- * (What are the social welfare effects of deworming? What type of people respond to material vs. signaling incentives?)  -->

## Results 

* Social signals significantly increase the demand for deworming treatment.
* Main mechanism is social image concerns. 
<!-- * Deworming take-up of others has no significant effect on individualsâ€™ deworming decision. -->
* Based on our structural model, we do find that signals alter the marginal response to costs and benefits. 

## Outline

1. Theoretical Framework

2. Empirical Context

3. Experiment Design

4. Structural Model

5. Conclusion

# Theoretical Framework

## Social Signaling

\begin{block}{}
\begin{equation*} U_i(y;v,x,\lambda) =  B_i(y;v) + \overbrace{\mu\textrm{E}_{-i}[V\mid y]}^{\mathclap{\textrm{reputational returns}}}
\end{equation*}
\end{block}

Individuals have different _pro-social_ types that are unobservable to others. Others can use your actions to draw inferences about your type [@Benabou2006;@Benabou2012].

* Net private benefit of deworming, $B_i(y;v)$.
* Pro-social activity, $y \in \{0, 1\}$, dewormed or not. 
* Intrinsic motivation, $V \sim F_V$. 
* Signaling visibility and desirability, $\mu$.
* $\textrm{E}_{-i}[V\mid y]$ is the inference that others make about own type $v$ based on your action $y$.

<!-- : health-conscious vs. careless, or good vs. bad citizen -->

## Equilibrium

Equilibrium $v^*$:

\[ B(y=1;v^*) + \overbrace{\mu \Delta[v^*]}^{\mathclap{\textrm{net reputational incentive}}} = 0 \]

where \[\Delta[v^*] = \expect{V | y =1} - \expect{V|y =0} = \overbrace{\expect{V| V > v^*}}^{\textrm{honor}} - \overbrace{\expect{V| V \leq v^*}}^{\textrm{stigma}}\]

is the difference in the average type based on observed actions.

Without signaling the equilibrium would be $$B(y=1;\tilde{v}) = 0$$ and thus, with $v^* < \tilde{v}$, signaling induces greater take-up of deworming. 

##

```{r prosocial-dist, fig.height=6.5}
vstar <- -1.25
vtilde <- -0.25

tibble(
  v = seq(-3, 3, 0.1),
  delta = dnorm(v),
) %>%
  bind_rows(
    "all" = .,
    "signaling" = filter(., v >= vstar), 
    "no-signaling" = filter(., v >= vtilde),
    .id = "type"
  ) %>% 
  ggplot() +
  geom_line(aes(v, delta), data = . %>% filter(fct_match(type, "all"))) +
  geom_area(aes(v, delta, fill = type), position = "identity", alpha = 0.3, data = . %>% filter(!fct_match(type, "all"))) +
  annotate("text", vstar + 0.3, 0.02, label = "Signaling") + # label = latex2exp::TeX("v^*")) +
  annotate("text", vtilde + 0.4, 0.02, label = "No Signaling") + # latex2exp::TeX(r"{\widetilde{v}}")) +
  labs(title = "Prosocial Type Distribution", x = "V", y = "") +
  theme(
    legend.position = "none",
    axis.text = element_blank(),
    panel.grid = element_blank(),
    panel.border = element_blank()
  ) +
  NULL 
```

<!-- ## Prediction 1 -->

<!-- **Prediction 1.** _If it is socially desirable to deworm and individuals care about their reputation (i.e., $\Delta[v^*] > 0$ and $\mu >0$), deworming take-up will be higher when individuals can signal their participation. The greater the visibility of actions, the larger the increase in take-up._ -->

## The Social Multiplier

Let $c$ be the cost (disutility) of deworming, and define the average take-up to be \[\bar{y}(c) = 1 - F_V(v^*(c)),\] the slope of which is 
\[ \bar{y}'(c) = f_V(v^*(c))\cdot\overbrace{\frac{-1}{1 + \mu \Delta'[v^*(c)]}}^{\textrm{social multiplier}} \]

## The Social Multiplier

\[ -\frac{\textrm{d}v^*(c)}{\textrm{d}c} = \frac{-1}{1 + \mu \Delta'[v^*(c)]} \]

* $\Delta'[v^*] < 0 \implies$ More sensitive to changes in cost/benefits (respectable or normal acts) 
* $\Delta'[v^*] > 0 \implies$ Less sensitive to changes in cost/benefits (admirable or heroic acts) 

```{r theory-delta, message=FALSE, fig.width=7.5, fig.height=2.5}
delta_data <- tibble(v = seq(-25, 25, 0.1), delta = delta(v)) 

delta_data %>% 
  filter(abs(v) <= 1) %>% 
  ggplot() +
  geom_smooth(aes(v, delta), color = "darkgrey") +
  geom_smooth(aes(v, delta * 1.1), color = alpha("darkgrey", 0.25)) +
  geom_smooth(aes(v, delta * 1.2), color = alpha("darkgrey", 0.25)) +
  geom_smooth(aes(v, delta * 0.9), color = alpha("darkgrey", 0.25)) +
  geom_smooth(aes(v, delta * 0.8), color = alpha("darkgrey", 0.25)) +
  geom_text(aes(x, y, label = t), 
            data = tibble(x = c(-0.75, 0, 0.75), y = c(1.85, 1.65, 1.85), t = c("Respectable Acts", "Modal Acts", "Admirable Acts"))) +
  labs(x = latex2exp::TeX("v^*$"), y = latex2exp::TeX(r"{$\Delta\[v^*\]$}")) +
  theme_minimal() +
  theme(axis.text = element_blank(), panel.grid = element_blank(), axis.line = element_line())
```

<!-- ## Prediction 2 -->

<!-- **Prediction 2.** _Greater observability of action ($\mu > 0$) would lead to:_ -->

<!--   a) _lesser sensitivity to costs when take-up is low (deworming is an admirable act)_ -->
<!--   b) _greater sensitivity to costs when take-up is high (deworming is a respectable act)_  -->
<!-- <!-- **Prediction 2.** _Changes in the cost of deworming lead to increases (decreases) in reputational returns, increasing (decreasing) the effect of signals and the share of individuals taking up deworming treatment._  --> -->

<!-- * If the cost to deworming is high, because of distance, would signaling mitigate the drop in take-up? -->
<!-- * If the cost to deworming is low, and take-up is a norm, would signaling amplify the effect of other incentives? -->

<!-- ## Alternative Mechanisms -->

<!-- 1. Signals have a private consumption value. -->
<!-- 2. Salience and social learning. -->

# Empirical Context

## Western Kenya

* Worms are endemic, infection prevalence is over 20%.
* Kenyan Government deworms children for free in schools. School-based deworming is a well-known program.
* Adults can purchase deworming treatment at pharmacies and clinics for 150 KSh.

* Baseline survey
    - 78% of adults knew about deworming treatment.
    - 68% had taken deworming treatment before.
    - 37% reported to have dewormed in the past 12 months.
    - 31% of adults had knowledge of externalities.
    
## Reported Social Value

```{r praise-stigma-plot, fig.width=8, fig.height=3}
baseline.data %>% 
  select(matches("^(praise|stigma)_[^_]+$")) %>% 
  gather(key = key, value = response) %>% 
  separate(key, c("praise.stigma", "topic"), "_") %>% 
  separate(topic, c("topic", "question.group"), -2) %>% 
  filter(!is.na(response)) %>% 
  count(praise.stigma, topic, response) %>% 
  group_by(praise.stigma, topic) %>% 
  mutate(n = n/sum(n)) %>% 
  ungroup %>%
  mutate_at(vars(praise.stigma, response), ~ fct_relabel(factor(.), str_to_title)) %>% 
  mutate(topic = fct_recode(factor(topic), 
                            "Wearing/not wearing nice clothes to church" = "clothe",
                            "Use Latrine/open defecation" = "defecat",
                            "Deworming/not deworming during MDA" = "dewor",
                            "Immunize/not immunize children" = "immuniz")) %>% 
  ggplot(aes(response)) +
  geom_col(aes(y = n), alpha = 0.5) +
  labs(y = "Proportion", x = "") +
  scale_y_continuous(breaks = seq(0.25, 1, 0.25)) +
  coord_flip() +
  facet_grid(topic ~ praise.stigma, labeller = label_wrap_gen(width = 20)) +
  theme_bw() +
  theme(legend.position = "bottom",
      strip.text.y = element_text(angle = 0), 
      strip.background = element_rect(colour = NA), 
      panel.border = element_blank()) 
```

## Community-based Deworming Program

* We worked with the government of Kenya and its county governments, providing free deworming treatment to approximately 200,000 adults in Busia, Siaya and Kakamega. 
* Community Health Volunteers (CHVs) provided deworming at 144 central locations over 12 days, Monday-Sunday 8am-5pm. 
* CHVs informed communities prior to deworming about the social benefits of deworming, the dates and location.  
<!-- * Community deworming program first of its kind.  -->

# Experimental Design

## Interventions 

Two primary interventions:

1. _Incentive_: incentivizing deworming take-up using.
    a) _Control_: no incentives.
    b) _Calendars_: a private incentive with low visibility.
    c) _Bracelets_: a social signal with some potential private valuation.
    d) _Indelible Ink_: a social signal with no private valuation.
    
    $Z \in \{\textrm{control, calendar, bracelet, ink}\}$
    
2. _Cost to Deworm_: manipulating cost by randomly varying the distance to deworming location.

    $G \in \{\textrm{close, far}\}$
    
## Experiment Diagram

![](../images/exp_diagram_nosms.pdf)

## Site Selection

```{r all-clusters-map, message=FALSE, warning=FALSE, fig.width=7.5, fig.height=3.5}
ggplot.clusters(rct.cluster.selection, include.cluster.ids = FALSE, suppress.selected.clusters = FALSE, 
                source = "stamen", maptype = "toner") +
  theme(legend.position = "none", axis.text = element_blank())
```

## Site Selection

```{r schools-map, message=FALSE, warning=FALSE, fig.width=7.5, fig.height=3.5}
ggplot.clusters(rct.cluster.selection, include.cluster.ids = FALSE, suppress.selected.clusters = TRUE, 
                source = "stamen", maptype = "toner") +
  theme(axis.text = element_blank())
```
    
## Social Signals

We introduce two signals for individuals to show they came for deworming treatment: (1) green bracelet and (2) indelible green ink.

![](../images/signal_bracelet.png){height=58%}

Bracelet saying "Treat worms: improve the health of your community"

## Private Incentive 
We introduce a (private) material reward, in form of a 2017 one-page calendar. We assume that the consumption value of the calendar is equal to that of the bracelet.

![](../images/calendar.png){height=65%}

## Random Distance to Treatment Location 

```{r act-dist, fig.width=8, fig.height=6}
analysis.data %>%  
  mutate(assigned.treatment = fct_relabel(assigned.treatment, str_to_title)) %>% 
  ggplot(aes(dist.to.pot)) +
  geom_density(aes(color = dist.pot.group, linetype = "Household")) +
  geom_density(aes(color = dist.pot.group, linetype = "Cluster Center"),
               data = mutate(village.centers, assigned.treatment = fct_relabel(assigned.treatment, str_to_title))) +
  geom_vline(xintercept = c(1250), linetype = "dashed") +
  labs(y = "Density", 
       caption = "Cluster centers were calculated as the centroid location of all households in cluster.") +
  scale_x_continuous("Distance to Treatment Location (meters)", breaks = seq(0, 10000, 2500/4)) +
  scale_color_discrete("Cluster Distance Assignment", labels = c("Close", "Far")) +
  scale_linetype_discrete("Distance From") +
  facet_wrap(~ assigned.treatment) +
  theme_minimal() +
  theme(legend.position = "bottom") 
```
# Reduced-Form Model

## Model

Hierarchical probit model: 
\begin{equation*}
\begin{split} %probability of deworming, conditional on treatment assignment incentive z and distance g (far/close) and set of parameters
    E[Y_i(z,g)] =   E[Y_i | Z = z, G= g, \beta_j] 
  = \Phi \big(\alpha_i + \beta_i(z) + \delta_i(g) + \gamma_i(z,g) \big) 
  \end{split}
\end{equation*}
where
\begin{align*}
    \alpha_i &= \alpha + \alpha^{\textrm{village}}_{j[i]} + \alpha^{\textrm{county}}_{k[i]} \\
    \beta_i(z) &= \beta(z) + \beta^{\textrm{county}}_{k[i]}(z) \\
    \delta_i(g) &= \delta(g) + \delta^{\textrm{county}}_{k[i]}(g) \\
    \gamma_i(z,g) &= \gamma(z,g) + \gamma^{\textrm{county}}_{k[i]}(z,g), 
\end{align*}
and $j[i]$ denotes village $j$ household $i$ belongs to and $k[i]$ denotes county $k$ that household $i$ belongs to.

## Reduced-Form Posterior Predictive Checking

```{r rf-ppc, fig.width=7.5, fig.height=5}
dist_fit_data %>% 
  filter(fct_match(fit_type, "fit"), fct_match(model_type, "reduced form")) %>% 
  select(model_type, obs_cluster_takeup_level) %>% 
  unnest(obs_cluster_takeup_level) %>% 
  filter(fct_match(assigned_treatment, c("control", "bracelet"))) %>%
  mutate(
    assigned_treatment = fct_relevel(assigned_treatment, "bracelet", "control"), # To keep consistent control/bracelet colors as in the ROC plots
  ) %>% 
  ggplot(aes(assigned_dist_obs)) +
  geom_point(aes(y = obs_prop_takeup, color = assigned_treatment), size = 0.8, show.legend = FALSE) + 
  # geom_crossbar(aes(y = per_0.5, ymin = per_0.1, ymax = per_0.9, color = assigned_treatment), width = 40) +
  geom_errorbar(aes(y = per_0.5, ymin = per_0.1, ymax = per_0.9, color = assigned_treatment), width = 20) +
  scale_color_canva("Treatment", labels = str_to_title, palette = "Fun and professional") +
  scale_x_continuous("Distance to Treatment [km]", labels = scales::label_number(scale = 1/1000, drop0trailing = TRUE)) +
  scale_y_continuous("Village Take-up") +
  labs(caption = "Point: observed village-level take-up. Vertical ranges: posterior predicted 80% credible interval.") +
  theme(legend.position = "bottom")
```

## Reduced-Form Average Treatment Effects

```{r rf-incentive-te, fig.width=7.5, fig.height=4.7, warning=FALSE, dependson="version"}
rf_te <- dist_fit_data %>%
  filter(fct_match(model_type, "reduced form")) %>% 
  mutate(est_takeup_te =
    map(est_takeup_te, 
        filter, 
        (is.na(assigned_dist_group_left) & is.na(assigned_dist_group_right)) | (assigned_dist_group_left == assigned_dist_group_right),
        assigned_treatment_left != assigned_treatment_right,
        fct_match(assigned_treatment_right, c("control")),
        fct_match(assigned_treatment_left, "bracelet") | !fct_match(assigned_treatment_right, "calendar"))) %>% 
  select(model, model_name, est_takeup_te, fit_type) %>% 
  unnest(est_takeup_te) %>%
  mutate(
    assigned_dist_group_left = fct_explicit_na(assigned_dist_group_left, "Combined") %>% 
      fct_relabel(str_to_title) %>% 
      fct_relevel("Combined"),
    assigned_treatment_left = fct_relabel(assigned_treatment_left, str_to_title)
  ) 
  
rf_te %>% {
    cowplot::plot_grid(
      plot_estimands(., assigned_treatment_left, results_group = fit_type, group_labels = c(fit = "Posterior", "prior-predict" = "Prior")) +
        scale_x_continuous("", breaks = seq(-1, 1, 0.1)) +
        scale_y_discrete("") +
        ggforce::facet_col(vars(assigned_dist_group_left), 
                   space = "free",
                   scales = "free_y") +
        theme(legend.position = "none") +
        NULL,
      
      ncol = 1
    )
  } 
```
## Reduced-Form Levels

```{r rf-levels, fig.width=7.5, fig.height=4.8, warning=FALSE, dependson="version"}
rf_levels <- dist_fit_data %>%
  filter(fct_match(model_type, "reduced form")) %>% 
  select(model, model_name, est_takeup_level, fit_type) %>% 
  unnest(est_takeup_level) %>%
  mutate(
    assigned_dist_group = fct_explicit_na(assigned_dist_group, "Combined") %>% 
      fct_relabel(str_to_title) %>% 
      fct_relevel("Combined"),
    assigned_treatment = fct_relabel(assigned_treatment, str_to_title)
  ) 

rf_levels %>% {
    cowplot::plot_grid(
      plot_estimands(., assigned_treatment, results_group = fit_type, group_labels = c(fit = "Posterior", "prior-predict" = "Prior"),
                     center_bar_size = 2) +
        scale_x_continuous("", breaks = seq(-1, 1, 0.1)) +
        scale_y_discrete("") +
        ggforce::facet_col(vars(assigned_dist_group), 
                   space = "free",
                   scales = "free_y") +
        theme(legend.position = "none") +
        NULL,
      
      ncol = 1
    )
  }
```
    
# Structural Model

## Deworming Take-up Model

\begin{block}{}
\begin{equation*} 
Y(z,d) = \mathbbm{1}\{B(z,d) + \mu(z,d)\Delta[w^*(z,d)] + \overbrace{V + U}^{W} > 0\}
\end{equation*}
\end{block}
where
\begin{align*}
w^*(z,d) &= - B(z,d) - \mu(z,d)\Delta[w^*(z,d)]  \\
\\
V &\sim \mathtt{Normal}(0, 1) \\
U &\sim \mathtt{Normal}(0, \sigma_{u})
\end{align*}

## Net Reputational Returns with Non-structural Shocks

\begin{block}{}
\begin{align*}
\Delta[w] &= \expect{V | y = 1} - \expect{ V| y = 0} \\
          &= \expect{V | W > w} - \expect{ V| W \leq w} = \frac{-\int_{-\infty}^\infty v F_u(w - v) f_v(v)\,\textrm{d}v}{F_w(w) [1 - F_w(w)]}
\end{align*}
\end{block}

* Individual shocks are driven by both a structural prosocial shock, $V$, and a non-structural shock, $U$.
* In assessing the net reputational returns of deworming, individuals need to account for both shocks.

## Net Reputational Returns with Non-structural Shocks

```{r delta-with-u-example, fig.width=3.5, fig.height=3.5}
sim_int <- expand.grid(
  w = seq(-2, 2, 0.1),
  u_sd = seq(0.0, 2.0, 0.1),
  mu = 1 
) %>% 
  filter(u_sd == 0 | mu == 1) %>% 
  rowwise() %>% 
  mutate(
    mu_delta = mu * calculate_delta(w, sqrt(1 + u_sd^2), u_sd),
    mu_delta_deriv = mu * calculate_delta_deriv(w, sqrt(1 + u_sd^2), u_sd)
  ) %>% 
  ungroup() %>% 
  pivot_longer(c(mu_delta, mu_delta_deriv), names_to = "delta_type")

sim_int %>% 
  filter(delta_type == "mu_delta") %>%
  ggplot(aes(w, value)) +
  geom_line(
    aes(group = u_sd), 
    data = . %>% 
      filter(mu == 1) %>% 
      mutate(type = r"{Add shocks: Holding $\mu = 1$ and varying $\sigma_u$}")
  ) +
  labs(
    x = latex2exp::TeX("$w$"),
    y = latex2exp::TeX(r"{Net reputational returns, $\Delta\[w\]$}"),
    caption = latex2exp::TeX(r"{Black lines move down as $\sigma_u$ increases.}")
  ) +
  NULL
```

## Deworming Take-up Model

\begin{block}{}
\begin{align*} 
  Y(b,r) &= \mathbbm{1}\{b + r + W > 0\} \\
  \\ 
  b &= B(z,d) \\ 
  r &= R(b,z,d) = \mu(z,d)\Delta[w^*(b,z,d)]
\end{align*}
\end{block}
where 
\[w^*(b,z,d) = - b - \mu(z,d)\Delta[w^*(b,z,d)] \]

\begin{figure}
\centering
\begin{tikzpicture}
  [
    node distance=1.5cm,
    line width=1,
    observed/.style={circle,fill=black,inner sep=0pt,minimum size=2mm},
    latent/.style={circle,draw=black,inner sep=0pt,minimum size=2mm},
    latent-edge/.style={->,dashed},
  ]
  
\node[observed] (Y) [label=above:$Y$] {};
\node[latent] (B) [label=above:$B$,left=of Y] {}
  edge[->] (Y);
\node[latent] (R) [label=below:$R$,below=of B] {}
  edge[->] (Y)
  edge[latent-edge,<->,bend right=45] (Y)
  edge[<-] (B);
\node[observed] (D) [label=120:$D$,left=of B] {}
  edge[->] (B)
  edge[->] (R);
\node[observed] (G) [label=left:$G$,left=of D] {}
  edge[->] (D);
\node[observed] (Z) [label=left:$Z$,below=of D] {}
  edge[->] (B)
  edge[->] (R);
\end{tikzpicture}
\end{figure}

## Willingness-to-Pay Experiment 

We conducted an experiment to elicit private valuation of incentive

1. Subjects (from the control arm) were asked to choose one of two gifts, a calendar or a bracelet (2% wanted neither).
2. Subjects were offered payment in order to switch to the gift not selected. Offer was randomly chosen from ${0, 10,\ldots,100}$ KSh.

## Wilingness-to-pay Experiment

* $G \in \{-1, 1\}$ indicates initial gift choice.
* $M \in \{0, 10, 20,\ldots, 100\}$ is the randomly assigned offer (in KSh).
* $S(m) \in \{0, 1\}$ indicates acceptance of $m$ KSh offer. 

\begin{align*}
  \text{Difference in valuation,}~V^{\textrm{wtp}} &\sim \mathtt{Normal}(\mu^{\textrm{wtp}}, \sigma^{\textrm{wtp}}) \\
  \mu^{\textrm{wtp}} &\sim \mathtt{Normal}(0, \tau^{\mu,\textrm{wtp}}) \\
  \sigma^{\textrm{wtp}} &\sim \mathtt{Normal^{+}}(0, \tau^{\sigma,\textrm{wtp}})
\end{align*}
\begin{equation*}
\mathcal{L} = 
  \begin{cases}
    \prob{V^{\textrm{wtp}} < -m} & s = 0 \land g = -1 \\ 
    \prob{V^{\textrm{wtp}} > m} & s = 0 \land g = 1 \\ 
    g\cdot\left(\prob{V^{\textrm{wtp}} < g \cdot m} - \prob{V^{\textrm{wtp}} < 0}\right) & s = 1
  \end{cases}
\end{equation*}

## Willingness-to-pay Experiment Results

```{r wtp-post, warning=FALSE, fig.height=4.5, fig.width=7.5, dependson="version"}
dist_fit_data %>% 
  filter(fct_match(fit_type, "fit"), fct_match(model_type, "structural")) %>%
  pull(wtp_results) %>%
  first() %>%
  plot_wtp_results()
```

## Private Benefit 

\begin{block}{}
\[ B(z,d) = \beta_z - \delta\cdot d,~z\in \{\textrm{control, ink, calendar, bracelet}\}, d\in\mathbb{R}^{+} \]
\end{block}

We restricted incentive's private utility to be
\begin{align*}
  \beta_{\textrm{calendar}} - \beta_{\textrm{bracelet}} &= \gamma^{\textrm{wtp}} \mu^{\textrm{wtp}} \\
  \\
  \gamma^{\textrm{wtp}} &\sim \mathtt{Normal}^{+}(0, \tau^{\gamma,\textrm{wtp}}).
\end{align*}

## First and Second Order Beliefs

* In the endline household survey, respondents were asked some questions about 10 random members of their community.
* Among these questions, they were asked:
    - Whether they knew the person.
    - Whether they know if the other person got dewormed.
    - Whether the other person knew if the respondent got dewormed.
* We want to identify how the signaling treatments affect:
    a) Perception of the observability of others' actions (first order)
    b) Perception of the observability of their own actions (second order)

## First and Second Order Beliefs

* $Z \in \{\textrm{control, ink, calendar, bracelet}\}$, assigned incentive treatment.
* $D \in \mathbb{R}^{+}$, assigned distance to deworming location.
* $Y^{\textrm{rec}} \in \{0,\ldots,10\}$, number of recognized peers.
* $Y^{\textrm{1ord}}(z,d)$, number of recognized peers respondent has knowledge of whether they got dewormed or not, 
  \begin{align*}
    Y^{\textrm{1ord}}(z,d) &\sim \mathtt{Binomial}(Y^{\textrm{rec}}, p^{\textrm{1ord}})) \\
    p^{\textrm{1ord}}(z,d) &= \mathsf{logit}^{-1}(\alpha^{\textrm{1ord}} + \beta_z^{\textrm{1ord}} + \delta^{\textrm{1ord}}\cdot d + \rho_z^{\textrm{1ord}} \cdot d).
  \end{align*}
* $Y^{\textrm{2ord}}(z,d)$, number of recognized peers who have knowledge of the respondent's deworming choice, 
  \begin{align*}
    Y^{\textrm{2ord}}(z,d) &\sim \mathtt{Binomial}(Y^{\textrm{rec}}, p^{\textrm{2ord}})) \\
    p^{\textrm{2ord}}(z,d) &= \mathsf{logit}^{-1}(\alpha^{\textrm{2ord}} + \beta_z^{\textrm{2ord}} + \delta^{\textrm{2ord}}\cdot d + \rho_z^{\textrm{2ord}} \cdot d).
  \end{align*}
  
## First and Second Order Beliefs Results

```{r beliefs-line-plot-post, fig.width=7.5, fig.height=5.0, dependson="version"}
dist_fit_data %>%
  filter(fct_match(fit_type, "fit"), fct_match(model_type, "structural")) %>%
  pull(beliefs_results) %>%
  first() %>%
  plot_beliefs_est(width = 0.7, crossbar_width = 0.4, include = "both")

```

## Social Benefit

\begin{block}{}
\[ R(b,z,d) = \mu(z,d)\Delta[w^*(b,z,d)] \] 
\end{block}

\begin{align*}
  \mu(z,d) &= \mu_o \exp(\beta_z^{\textrm{1ord}} + \delta^{\textrm{1ord}}\cdot d + \rho^{\textrm{1ord}}_z \cdot d) \\
  \\ 
  \mu_o &\sim \mathtt{Normal}^{+}(0, \tau^{\mu_o})
\end{align*}

## Treatment Effects

For $z\in\{\textrm{ink, calendar, bracelet}\}, g\in\{\textrm{close, far}\}$:

* Overall Effect,  
    \[\expect{Y(z,g)} - \expect{Y(\textrm{control},g)}.  \]
* Social Signaling Effect, 
    \[\expect{Y(z,g,B(\textrm{control}))} - \expect{Y(\textrm{control},g)}.  \]
* Private Incentive Effect,
    \[\expect{Y(\textrm{control},g,B(z))} - \expect{Y(\textrm{control},g)}.  \]
    
## Structural Counterfactual Identification

\begin{multline*}
\expect{Y(z,g,B(z'))}\\ 
= \int_0^\infty \expect*{Y | Z = z, D = d, b = B\left(z',d\right)} \prob{D = d | G = g}\,\mathrm{d}d 
\end{multline*}

\begin{figure}
\centering
\begin{tikzpicture}
  [
    node distance=1.5cm,
    line width=1,
    observed/.style={circle,fill=black,inner sep=0pt,minimum size=2mm},
    latent/.style={circle,draw=black,inner sep=0pt,minimum size=2mm},
    latent-edge/.style={->,dashed},
  ]
  
\node[observed] (Y) [label=above:$Y^{*}$] {};
\node[latent] (B) [label=120:$B^{*}$,left=of Y] {}
  edge[->] (Y);
\node[observed] (Z2) [label=above:$z'$,above=of B] {}
  edge[->] (B);
\node[latent] (R) [label=below:$R^*$,below=of B] {}
  edge[->] (Y)
  edge[<-] (B)
  edge[latent-edge,<->,bend right=45] (Y);
\node[observed] (D) [label=120:$D^*$,left=of B] {}
  edge[->] (B)
  edge[->] (R);
\node[observed] (G) [label=left:$g$,left=of D] {}
  edge[->] (D);
\node[observed] (Z2) [label=left:$z$,below=of D] {}
  edge[->] (R);
\end{tikzpicture}
\end{figure}

## Posterior Predictive Checking

```{r ppc, fig.width=7.5, fig.height=5}
dist_fit_data %>% 
  filter(fct_match(fit_type, "fit"), fct_match(model_type, "structural")) %>% 
  select(model_type, obs_cluster_takeup_level) %>% 
  unnest(obs_cluster_takeup_level) %>% 
  filter(fct_match(assigned_treatment, c("control", "bracelet"))) %>%
  mutate(
    assigned_treatment = fct_relevel(assigned_treatment, "bracelet", "control"), # To keep consistent control/bracelet colors as in the ROC plots
  ) %>% 
  ggplot(aes(assigned_dist_obs)) +
  geom_point(aes(y = obs_prop_takeup, color = assigned_treatment), size = 0.8, show.legend = FALSE) + 
  # geom_crossbar(aes(y = per_0.5, ymin = per_0.1, ymax = per_0.9, color = assigned_treatment), width = 40) +
  geom_errorbar(aes(y = per_0.5, ymin = per_0.1, ymax = per_0.9, color = assigned_treatment), width = 20) +
  scale_color_canva("Treatment", labels = str_to_title, palette = "Fun and professional") +
  scale_x_continuous("Distance to Treatment [km]", labels = scales::label_number(scale = 1/1000, drop0trailing = TRUE)) +
  scale_y_continuous("Village Take-up") +
  labs(caption = "Point: observed village-level take-up. Vertical ranges: posterior predicted 80% credible interval.") +
  theme(legend.position = "bottom")
```
    
## Incentive Average Treatment Effect
    
```{r incentive-te, fig.width=7.5, fig.height=4.75, warning=FALSE, dependson="version"}
incentive_te <- dist_fit_data %>%
  filter(fct_match(model_type, "structural")) %>% 
  mutate(est_takeup_te =
    map(est_takeup_te, 
        filter, mu_assigned_treatment_left == assigned_treatment_left, mu_assigned_treatment_right == assigned_treatment_right,
        (is.na(assigned_dist_group_left) & is.na(assigned_dist_group_right)) | (assigned_dist_group_left == assigned_dist_group_right),
        assigned_treatment_left != assigned_treatment_right,
        fct_match(assigned_treatment_right, c("control")),
        fct_match(assigned_treatment_left, "bracelet") | !fct_match(assigned_treatment_right, "calendar"))) %>% 
  select(model, model_name, est_takeup_te, fit_type) %>% 
  unnest(est_takeup_te) %>%
  mutate(
    assigned_dist_group_left = fct_explicit_na(assigned_dist_group_left, "Combined") %>% 
      fct_relabel(str_to_title) %>% 
      fct_relevel("Combined"),
    assigned_treatment_left = fct_relabel(assigned_treatment_left, str_to_title)
  ) 

incentive_te %>% {
    cowplot::plot_grid(
      plot_estimands(., assigned_treatment_left, results_group = fit_type, group_labels = c(fit = "Posterior", "prior-predict" = "Prior"),
                     center_bar_size = 2) +
        scale_x_continuous("", breaks = seq(-1, 1, 0.1)) +
        scale_y_discrete("") +
        ggforce::facet_col(vars(assigned_dist_group_left), 
                   space = "free",
                   scales = "free_y") +
        theme(legend.position = "none") +
        NULL,
      ncol = 1
    )
  } 
```

## Incentive Take-up Level

```{r incentive-levels, fig.width=7.5, fig.height=4.7, warning=FALSE, dependson="version"}
incentive_levels <- dist_fit_data %>% 
  filter(fct_match(model_type, "structural")) %>% 
  mutate(est_takeup_level =
    map(est_takeup_level, filter, assigned_treatment == mu_assigned_treatment)) %>%  
  select(model, model_name, est_takeup_level, fit_type) %>% 
  unnest(est_takeup_level) %>%
  mutate(
    assigned_dist_group = fct_explicit_na(assigned_dist_group, "Combined") %>% 
      fct_relabel(str_to_title) %>% 
      fct_relevel("Combined"),
    assigned_treatment = fct_relabel(assigned_treatment, str_to_title),
  ) 

incentive_levels %>% {
    cowplot::plot_grid(
      plot_estimands(., assigned_treatment, results_group = fit_type, group_labels = c(fit = "Posterior", "prior-predict" = "Prior"),
                     center_bar_size = 2) +
        scale_x_continuous("", breaks = seq(-1, 1, 0.1)) +
        scale_y_discrete("") +
        ggforce::facet_col(vars(assigned_dist_group), 
                   space = "free",
                   scales = "free_y") +
        theme(legend.position = "none") +
        NULL,
      
      ncol = 1
    )
  }
```

## Signaling Average Treatment Effect

```{r signaling-te, fig.width=7.5, fig.height=4.75, warning=FALSE, dependson="version"}
signaling_te <- dist_fit_data %>% 
  filter(fct_match(model_type, "structural")) %>% 
  select(model, model_name, est_takeup_te, fit_type) %>% 
  unnest(est_takeup_te) %>%
  filter(
    (is.na(assigned_dist_group_left) & is.na(assigned_dist_group_right)) | (assigned_dist_group_left == assigned_dist_group_right),
    if_all(c(assigned_treatment_left, assigned_treatment_right), fct_match, "control"),
    !is.na(mu_assigned_treatment_left),
    fct_match(mu_assigned_treatment_left, "bracelet") | !fct_match(mu_assigned_treatment_right, "calendar"),
    fct_match(mu_assigned_treatment_right, "control"),
  ) %>%
  mutate(
    assigned_dist_group_left = fct_explicit_na(assigned_dist_group_left, "Combined") %>% 
      fct_relabel(str_to_title) %>% 
      fct_relevel("Combined"),
    mu_assigned_treatment_left = fct_relabel(mu_assigned_treatment_left, str_to_title),
  ) 

signaling_te %>% {
    cowplot::plot_grid(
      plot_estimands(., mu_assigned_treatment_left, results_group = fit_type, group_labels = c(fit = "Posterior", "prior-predict" = "Prior"),
                     center_bar_size = 2) +
        scale_x_continuous("", breaks = seq(-1, 1, 0.05)) +
        scale_y_discrete("") +
        ggforce::facet_col(vars(assigned_dist_group_left), 
                   space = "free",
                   scales = "free_y") +
        theme(legend.position = "none") +
        NULL,
      
      ncol = 1
    )
  } 
```

<!-- ## Signaling Take-up Levels -->

```{r, fig.width=7.5, fig.height=4.7, warning=FALSE, eval=FALSE, dependson="version"}
dist_fit_data %>% 
  filter(fct_match(model_type, "structural")) %>% 
  select(model, model_name, est_takeup_level, fit_type) %>% 
  unnest(est_takeup_level) %>%
  filter(
    fct_match(assigned_treatment, "control"),
    !is.na(mu_assigned_treatment),
  ) %>%
  mutate(
    assigned_dist_group = fct_explicit_na(assigned_dist_group, "Combined") %>% 
      fct_relabel(str_to_title) %>% 
      fct_relevel("Combined"),
    
    mu_assigned_treatment = fct_relabel(mu_assigned_treatment, str_to_title),
  ) %>% {
    cowplot::plot_grid(
      plot_estimands(., mu_assigned_treatment, results_group = fit_type, group_labels = c(fit = "Posterior", "prior-predict" = "Prior"), center_bar_size = 2) +
        scale_x_continuous("", breaks = seq(-1, 1, 0.1)) +
        scale_y_discrete("", labels = str_to_title) +
        labs(
          title = "Signaling Level",
          subtitle = "Holding private incentive at the control level."
        ) +
        ggforce::facet_col(vars(assigned_dist_group), 
                   space = "free",
                   scales = "free_y") +
        theme(legend.position = "none") +
        NULL,
      
      ncol = 1
    )
  }
  
```

## Private Incentive Average Treatment Effect

```{r private-incentive-te, fig.width=7.5, fig.height=2, dependson="version"}
private_incentive_te <- dist_fit_data %>% 
  filter(fct_match(model_type, "structural")) %>% 
  select(model, model_name, est_takeup_te, fit_type) %>% 
  unnest(est_takeup_te) %>%
  filter(
    (is.na(assigned_dist_group_left) & is.na(assigned_dist_group_right)) | (assigned_dist_group_left == assigned_dist_group_right),
    !is.na(mu_assigned_treatment_left),
    !is.na(mu_assigned_treatment_right),
    if_all(c(mu_assigned_treatment_left, mu_assigned_treatment_right), fct_match, "control"),
    fct_match(assigned_treatment_left, "bracelet") | !fct_match(assigned_treatment_right, "calendar"),
    fct_match(assigned_treatment_right, "control"),
  ) %>%
  mutate(
    assigned_dist_group_left = fct_explicit_na(assigned_dist_group_left, "Combined") %>% 
      fct_relabel(str_to_title) %>% 
      fct_relevel("Combined"),
    assigned_treatment_left = fct_relabel(assigned_treatment_left, str_to_title),
  ) %>% 
  filter(fct_match(assigned_dist_group_left, "Combined")) # Distance doesn't matter for private valuation 

private_incentive_te %>% { 
    cowplot::plot_grid(
      plot_estimands(., assigned_treatment_left, results_group = fit_type, group_labels = c(fit = "Posterior", "prior-predict" = "Prior"), center_bar_size = 2) +
        scale_x_continuous("", breaks = seq(-1, 1, 0.05)) +
        scale_y_discrete("") +
        # ggforce::facet_col(vars(assigned_dist_group_left), 
        #            space = "free",
        #            scales = "free_y") +
        theme(legend.position = "none") +
        NULL,
      
      ncol = 1
    )
  }
```

<!-- ## Distance Model -->

<!-- Casual model function -->
<!-- \begin{equation*}  -->
<!--   d \leftarrow f_D(g; m, \boldsymbol{\pi}, u_D) = \pi_{gm} + u_D -->
<!-- \end{equation*} -->

<!-- Finite-mixture statistical model ($M = 2$) -->
<!-- \begin{align*} -->
<!-- \prob{D(g) = d} = \prob{D = g | G = g} = \sum_m^M \lambda_m \frac{\phi\left(\frac{d - \pi_{gm}}{\eta_{gm}}\right)}{1 - \Phi\left(\frac{d - \pi_{gm}}{\eta_{gm}}\right)}  -->
<!-- \end{align*} -->
<!-- and -->
<!-- \begin{align*} -->
<!--   \boldsymbol{\rho} &\sim \mathtt{Dirichlet}(\boldsymbol{\iota}_M) \\ -->
<!--   \pi_{gm} &\sim \mathtt{Normal^+}(0, 1) \\ -->
<!--   \eta_{gm} &\sim \mathtt{Normal^+}(0, 1). -->
<!-- \end{align*} -->
<!-- We also restrict $\pi_{\textrm{far},m} > \pi_{\textrm{close},m}$. -->

<!-- ## Structural Causal Model DAG -- With Salience -->

<!-- We consider an alternative model allowing for other types of social influence, e.g., salience or learning. -->

<!-- \begin{align*}  -->
<!-- \bar{b} &\leftarrow f_{\overline{B}}(z, d) = \beta_{z} - d\cdot\delta - \overbrace{d\cdot\mu_z\psi}^{\mathclap{\textrm{salience/learning}}}  -->
<!-- \end{align*} -->

## Net Reputational Returns, $\Delta[w]$

```{r estimated-delta, fig.width=7.5, fig.height=4.75, dependson="version"}
dist_fit_data %>% 
  filter(fct_match(fit_type, "fit"), fct_match(model_type, "structural")) %>% 
  select(sim_delta) %>% 
  unnest(sim_delta) %>% 
  ggplot(aes(w)) +
  geom_line(aes(y = per_0.5)) +
  geom_ribbon(aes(ymin = per_0.25, ymax = per_0.75), alpha = 0.3) +
  geom_ribbon(aes(ymin = per_0.1, ymax = per_0.9), alpha = 0.3) +
  labs(
    x = "w", y = latex2exp::TeX(r"{$\Delta\[w\]$}"),
    caption = "Line: Median. Outer ribbon: 80% credible interval. Inner ribbon: 50% credible interval." 
  ) +
  NULL
```

## Take-up Probability and Distance 

```{r take-up-prob, fig.width=7.5, fig.height=4.75, dependson="version"}
dist_prob_plot <- dist_fit_data %>% 
  filter(fct_match(fit_type, "fit"), fct_match(model_type, "structural")) %>% 
  # transmute(across(c(cluster_w_cutoff_control, cluster_w_cutoff_bracelet), map, ~ mutate(.x, roc_distance = roc_distance / 1000))) %>% 
  transmute(
    across(c(cluster_takeup_prop_control, cluster_takeup_prop_bracelet), map, ~ mutate(.x, roc_distance = roc_distance / 1000)),
    obs_cluster_takeup_level,
  ) %>% 
  pivot_longer(-obs_cluster_takeup_level, names_to = "treatment", names_pattern = "_(control|bracelet)$") %>% 
  mutate(
    obs_cluster_takeup_level = map2(obs_cluster_takeup_level, treatment, ~ filter(.x, fct_match(assigned_treatment, .y)))
  ) %>% 
  ggplot(aes(roc_distance)) +
  geom_line(aes(y = per_0.5, color = treatment), data = . %>% unnest(value)) +
  geom_ribbon(aes(ymin = per_0.25, ymax = per_0.75, fill = treatment), alpha = 0.3, data = . %>% unnest(value)) +
  geom_ribbon(aes(ymin = per_0.1, ymax = per_0.9, fill = treatment), alpha = 0.3, data = . %>% unnest(value)) +
  geom_rug(
    aes(dist, color = assigned.treatment),
    alpha = 0.75,
    data = analysis_data %>%
      filter(fct_match(assigned.treatment, c("control", "bracelet"))) %>% 
      distinct(cluster_id, assigned.treatment, dist = cluster.dist.to.pot / 1000)) +
  scale_color_canva("Treatment (z)", labels = str_to_title, palette = "Fun and professional") +
  scale_fill_canva("Treatment (z)", labels = str_to_title, palette = "Fun and professional") +
  labs(
    x = "Distance to Treatment (d) [km]", y = latex2exp::TeX("Take-up Probability, $1 - F_w(w^*(z,d))$") ,
    caption = "Line: Median. Outer ribbon: 80% credible interval. Inner ribbon: 50% credible interval." 
      
  ) +
  coord_cartesian(ylim = c(0, 0.55)) +
  NULL

dist_prob_plot
```
## Take-up Probability and Distance 

```{r take-up-prob-with-obs-takeup, fig.width=7.5, fig.height=4.75, dependson="version"}
dist_prob_plot +
  geom_point(aes(assigned_dist_obs / 1000, y = obs_prop_takeup, color = treatment), size = 0.8, show.legend = FALSE, data = . %>% unnest(obs_cluster_takeup_level)) +
  NULL
```

## Take-up Probability and Distance 

```{r take-up-prob-with-obs-takeup-and-linerange, fig.width=7.5, fig.height=4.75, dependson="version"}
dist_prob_plot +
  geom_linerange(aes(assigned_dist_obs / 1000, ymin = per_0.1, ymax = per_0.9, color = treatment), data = . %>% unnest(obs_cluster_takeup_level)) +
  geom_point(aes(assigned_dist_obs / 1000, y = obs_prop_takeup, color = treatment), size = 0.8, show.legend = FALSE, data = . %>% unnest(obs_cluster_takeup_level)) +
  NULL
```

## Take-up Rate of Change 

We want to estimate the causal effect of signals on the _take-up rate-of-change with respect to distance_, holding $d$ and $w^*$ fixed. 

\begin{align*}
\frac{\partial\expect{Y(z,d,w)}}{\partial d}\Biggr|_{\substack{z = \textrm{bracelet}\\d = \tilde{d}\\w=w^*(\textrm{control}, \tilde{d})}}-\frac{\partial\expect{Y(z,d,w)}}{\partial d}\Biggr|_{\substack{z = \textrm{control}\\d = \tilde{d}\\w=w^*(\textrm{control}, \tilde{d})}}
\end{align*}
where $\tilde{d} \in \mathbb{R}^{+}$.
\[ \frac{\partial\expect{Y(z,d,w)}}{\partial d} = \frac{-f_w(w)\left\{\delta - \frac{\partial \mu(z,d)}{\partial d}\Delta[w] \right\}}{1+\mu(z,d)\Delta'[w]} \]

## Rates of Change

```{r rate-of-change, fig.width=7.5, fig.height=4.75, dependson="version"}
dist_fit_data %>% 
  filter(fct_match(fit_type, "fit"), fct_match(model_type, "structural")) %>% 
  transmute(across(c(cluster_roc_control, cluster_roc_bracelet), ~ { map2(.x, stan_data, ~ { 
    mutate(.x,
      roc_distance = roc_distance / 1000,
      across(starts_with("per_"), divide_by, sd(.y$analysis_data$cluster.dist.to.pot)), 
      across(starts_with("per_"), multiply_by, 1000),
      across(starts_with("per_"), multiply_by, 100)
    ) 
  })})) %>%
  pivot_longer(everything(), names_to = "treatment", names_pattern = "_(control|bracelet)$") %>% 
  unnest(value) %>% 
  ggplot(aes(roc_distance)) +
  geom_line(aes(y = per_0.5, color = treatment)) +
  geom_ribbon(aes(ymin = per_0.25, ymax = per_0.75, fill = treatment), alpha = 0.4) +
  geom_ribbon(aes(ymin = per_0.1, ymax = per_0.9, fill = treatment), alpha = 0.4) +
  geom_rug(
    aes(dist, color = assigned.treatment),
    alpha = 0.75,
    data = analysis_data %>%
      filter(fct_match(assigned.treatment, c("control", "bracelet"))) %>% 
      distinct(cluster_id, assigned.treatment, dist = cluster.dist.to.pot / 1000)) +
  scale_color_canva("Treatment (z)", labels = str_to_title, palette = "Fun and professional") +
  scale_fill_canva("Treatment (z)", labels = str_to_title, palette = "Fun and professional") +
  labs(
    x = "Distance to Treatment (d) [km]", y = latex2exp::TeX(r"{Rate of Change \[pp/km\]}") ,
    caption = "Line: Median. Outer ribbon: 80% credible interval. Inner ribbon: 50% credible interval." 
      
  ) +
  NULL
```

## Effect on the Rate of Change

```{r rate-of-change-diff, fig.width=7.5, fig.height=4.75, dependson="version"}
dist_fit_data %>% 
  filter(fct_match(fit_type, "fit"), fct_match(model_type, "structural")) %>% 
  transmute(y_rate_of_change_diff = map2(cluster_roc_diff, stan_data, ~ {
    mutate(.x,
      roc_distance = roc_distance / 1000,
      across(starts_with("per_"), divide_by, sd(.y$analysis_data$cluster.dist.to.pot)), 
      across(starts_with("per_"), multiply_by, 1000),
      across(starts_with("per_"), multiply_by, 100)
    ) 
  })) %>%
  unnest(y_rate_of_change_diff) %>% 
  ggplot(aes(roc_distance)) +
  geom_line(aes(y = per_0.5)) +
  geom_ribbon(aes(ymin = per_0.25, ymax = per_0.75), alpha = 0.25) +
  geom_ribbon(aes(ymin = per_0.1, ymax = per_0.9), alpha = 0.25) +
  geom_rug(
    aes(dist, color = assigned.treatment),
    alpha = 0.75,
    data = analysis_data %>%
      filter(fct_match(assigned.treatment, c("control", "bracelet"))) %>% 
      distinct(cluster_id, assigned.treatment, dist = cluster.dist.to.pot / 1000)) +
  scale_color_canva("", labels = str_to_title, palette = "Fun and professional") +
  labs(
    x = "Distance to Treatment [km]", y = "Difference in Rate of Change [pp/km]",
    caption = "Line: Median. Outer ribbon: 80% credible interval. Inner ribbon: 50% credible interval." 
  ) +
  coord_cartesian(ylim = c(0, 10)) +
  NULL
```
<!-- ## Reduced-Form Average Treatment Effect -->

# Conclusion

## Conclusion

* Signals are a viable incentivization mechanism in contexts with a public good contribution and where image concerns are important.
    - In the context of mass drug administration the overall level of take-up was likely too low.
* Bracelets proved to be the best signal, while ink resulted in enough disutility to counter any reputational returns.
* In our reduced form model, we showed that nearly half of the effect of the bracelets incentives is due to social signaling.
* In our structural model, we showed that ink and calendar incentives also has positive social signaling effects.
* Signals do appear to have an effect on the rate of take-up in response to cost/benefit.

## 

Contacts:

* Anne Karing (\href{mailto:akaring@princeton.edu}{akaring@princeton.edu})
* Karim Naguib (\href{mailto:karimn2.0@gmail.com}{karimn2.0@gmail.com})

Code Repo: https://github.com/karimn/takeup 

## References

## Reduced-Form Quantities

```{r, include=FALSE}
stan_data <- dist_fit_data %>%
        filter(fct_match(fit_type, "fit"), fct_match(model_type, "structural")) %>%
        pull("stan_data") %>%
        first()

rmarkdown::render(
  "estimated_quantities.Rmd", 
  params = lst(
    rf_te, rf_levels, incentive_levels, signaling_te, private_incentive_te, stan_data) 
)
```

