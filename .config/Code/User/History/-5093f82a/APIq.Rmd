---
title: FAKE ZM Plots
output: pdf_document
---




```{r setup, include=FALSE}
library(knitr)
library(tidyverse)
library(broom)
library(furrr)
opts_chunk$set(echo = FALSE, warning = FALSE, 
               cache = FALSE, 
               fig.align = "center")
```


```{r}
rural_df = read_csv("../../data/output/hh-survey/clean_rural_data.csv")
urban_df = read_csv("../../data/output/hh-survey/clean_urban_data.csv")

karachi_east_df = urban_df %>%
    filter(district == "KARACHI EAST DISTRICT") 

kambar_df = rural_df %>%
    filter(str_detect(district, "KAMBAR")) %>%
    filter(!(is.na(pop) | is.na(lit))) # two observations
```


## N STC Per Taluka

```{r}
kambar_df %>%
    mutate(taluka_id = paste0("taluka_", taluka_id)) %>%
    group_by(taluka_id) %>%
    summarise(
        N_stc_per_taluka = n_distinct(stc_id),
        N_tc_per_taluka = n_distinct(tc_id), 
        total_pop_per_taluka = sum(pop), 
        mean_pop_per_village = mean(pop))
```



```{r}
kambar_df %>%
    ggplot(aes( 
        x = pop, 
        fill = factor(taluka_id)
    )) +
    geom_histogram(
        colour = "black"
    ) +
    facet_wrap(~taluka_id) +
    scale_x_log10() +
    theme_bw() +
    theme(legend.position = "bottom") +
    labs( 
        title = "Village Population by Taluka, Rural Kambar", 
        fill = "Taluka", 
        x = "Village Population"
    ) 
```


## Karachi EAST


```{r}

karachi_east_df %>%
    mutate(subdivision_id = paste0("subdiv_", subdivision_id)) %>%
    group_by(subdivision_id) %>%
    summarise(
        N_charges_per_subdiv = n_distinct(charge_id), 
        N_circles_per_charge = n_distinct(circle_id), 
        total_pop_per_subdivision = sum(pop), 
        mean_pop_per_circle = mean(pop))
```



```{r}

karachi_east_df %>%
    ggplot(aes( 
        x = pop, 
        fill = factor(subdivision_id)
    )) +
    geom_histogram(colour = "black") +
    facet_wrap(~subdivision_id) +
    theme_bw() +
    scale_x_log10() +
    theme_bw() +
    theme(legend.position = "bottom") +
    labs( 
        title = "Circle Population by Subdivision, Karachi East", 
        fill = "Subdivision", 
        x = "Circle Population"
    ) 


```

## Sample Considerations

We want to sample from every _taluka_ or _subdivision_ for rural Kambar and Karachi 
East respectively. So we want to know, should we sample villages such that we 
observe many __STCs__ and few 
__TCs__ per __STC__; or should we sample villages such that we 
observe many __TCs__ per __STC__ and relatively 
fewer __STCs__. 

The Karachi East analog is should we sample blocks so that we see many __charges__ 
and few __circles__ per __charge__ or blocks such that we see few __charges__ but 
many __circles__ per __charge__.

In a first best scenario we'd sample as many STCs/Charges as possible. However, 
it costs more to sample  a greater number of STCs/Charges because the location of each 
village/block will be more dispersed. In other words, it's cheaper to sample 
many TCs/circles per STC/charge but we learn less about zero-dose 
children because of intra-cluster correlation.    


## Calculating ICC


We think literacy rate is highly (negatively) correlated to zero dose rate. For 
instance, a UN survey of Karachi's slums found that conditional on being a zero 
dose child, 93\% of mothers were illiterate. Therefore using village/circle level 
literacy data we calculate literacy ICC and use this in place of zero dose ICC.

We calculate ICC using two methods: one uses the normal approximation to the 
Binomial and calculates the classic sum of squares within village/circle vs sum of 
squares between villages/circles. The other uses a random effects logistic model 
(which itself has to take a first order approximation). The final ICC used 
splits the difference and averages over these two methods to give rural Kambar 
$= 0.131$ and Karachi East $= 0.172$. 


_Ideally we'd calculate the correlation structure of charges and then circles 
within charges and make our simulations reflect this nested correlation 
structure but this would be a bit involved._


